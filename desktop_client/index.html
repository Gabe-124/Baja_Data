<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Baja Telemetry Client</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet.draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Header bar with connection controls -->
  <header class="app-header">
    <div class="header-left">
  <h1>Baja Telemetry</h1>
      <div class="connection-status" id="connectionStatus">
        <span class="status-dot disconnected"></span>
        <span class="status-text">Disconnected</span>
      </div>
    </div>
    <div class="header-right">
      <select id="portSelect" class="port-select">
        <option value="">Select LoRa Port...</option>
      </select>
      <button id="connectBtn" class="btn btn-primary">Connect</button>
      <button id="disconnectBtn" class="btn btn-secondary" disabled>Disconnect</button>
      <button id="testTxBtn" class="btn btn-test" disabled>Start Test TX</button>
      <button id="simulateGpsBtn" class="btn btn-secondary" title="Generate fake GPS laps without hardware">Start Simulation</button>
    </div>
  </header>

  <!-- Main content area -->
  <div class="app-container">
    <!-- Left panel: Track map -->
    <div class="panel map-panel">
      <div class="panel-header">
        <h2>Track Map</h2>
        <div class="map-controls">
          <button id="centerTrackBtn" class="btn-icon" title="Show entire track">ğŸ“</button>
          <button id="centerCarBtn" class="btn-icon" title="Center on car">ğŸï¸</button>
          <!-- Toggle between map tile and satellite imagery -->
          <button id="toggleMapTypeBtn" class="btn-icon" title="Toggle satellite / map">ğŸ›°ï¸</button>
          <button id="editTrackBtn" class="btn-icon" title="Draw/Edit track">ğŸ› ï¸</button>
          <button id="saveTrackBtn" class="btn-icon" title="Save track">ğŸ’¾</button>
          <button id="importTrackBtn" class="btn-icon" title="Import track">ğŸ“</button>
        </div>
      </div>
      <div id="map" class="map-container"></div>
      <div class="map-terminal" id="mapTerminal">
        <div class="map-terminal-header">
          <div>
            <div class="terminal-title">LoRa Command Console</div>
            <div class="terminal-hint">Send quick commands to the car ECU</div>
            <div class="console-collapsed-label">Console hidden â€” tap Show to expand</div>
          </div>
          <div class="map-terminal-actions">
            <button id="toggleConsoleBtn" class="btn btn-secondary btn-compact">Hide Console</button>
            <button id="clearCommandLogBtn" class="btn-icon" title="Clear console">ğŸ—‘ï¸</button>
          </div>
        </div>
        <div class="map-terminal-log" id="commandLog">
          <div class="empty-state">No commands sent yet</div>
        </div>
        <div class="map-terminal-input">
          <input type="text" id="commandInput" placeholder="Enter command, e.g. PING or SET_FAN 1" autocomplete="off" />
          <button id="sendCommandBtn" class="btn btn-primary btn-compact">Send</button>
        </div>
      </div>
      <div class="map-footer">
        <div class="telemetry-mini">
          <span>ğŸ“¡ <span id="gpsStatus">No Fix</span></span>
          <span>ğŸ›°ï¸ <span id="satCount">0</span> sats</span>
          <span>ğŸ“ HDOP: <span id="hdopValue">--</span></span>
        </div>
      </div>
    </div>

    <!-- Resizable splitter -->
    <div class="resize-handle" id="resizeHandle"></div>

    <!-- Right panel: Timing and data -->
    <div class="panel info-panel">
      <!-- Current lap timing -->
      <div class="timing-section">
        <div class="panel-header">
          <h2>Current Lap</h2>
        </div>
        <div class="current-lap-display">
          <div class="speedometer-widget">
            <div class="speedometer-gauge" aria-label="Current speed">
              <div class="speedometer-scale">
                <span class="speedometer-tick" style="--angle:-130deg;">
                  <span class="tick-mark"></span>
                  <span class="tick-label">0</span>
                </span>
                <span class="speedometer-tick" style="--angle:-65deg;">
                  <span class="tick-mark"></span>
                  <span class="tick-label">10</span>
                </span>
                <span class="speedometer-tick" style="--angle:0deg;">
                  <span class="tick-mark"></span>
                  <span class="tick-label">20</span>
                </span>
                <span class="speedometer-tick" style="--angle:65deg;">
                  <span class="tick-mark"></span>
                  <span class="tick-label">30</span>
                </span>
                <span class="speedometer-tick" style="--angle:130deg;">
                  <span class="tick-mark"></span>
                  <span class="tick-label">40</span>
                </span>
              </div>
              <div class="speedometer-needle" id="speedNeedle"></div>
              <div class="speedometer-center-cap"></div>
              <div class="speedometer-value">
                <span id="speedValue">0</span>
                <span class="speed-unit">mph</span>
              </div>
            </div>
          </div>
          <div class="lap-metrics">
            <div class="lap-number">Lap <span id="currentLapNum">--</span></div>
            <div class="lap-time" id="currentLapTime">00:00.000</div>
            <!-- Delta display (time ahead/behind best lap) -->
            <div class="delta-container">
              <div class="delta-label">Delta to Best</div>
              <div class="delta-value" id="deltaValue">--</div>
            </div>
          </div>
          <div class="best-lap-inline">
            <div class="best-lap-inline-label">Best Lap</div>
            <div class="best-lap-inline-time" id="bestLapTime">--</div>
            <div class="best-lap-inline-meta">Lap <span id="bestLapNum">--</span></div>
          </div>
        </div>
      </div>

      <!-- Lap times table -->
      <div class="lap-times-section">
        <div class="panel-header">
          <h3>Lap Times</h3>
          <div class="lap-times-actions">
            <button id="lapSortToggleBtn" class="btn btn-secondary btn-compact" title="Toggle lap order">Sort: Lap #</button>
            <button id="clearLapsBtn" class="btn-icon" title="Clear all laps">ğŸ—‘ï¸</button>
          </div>
        </div>
        <div class="lap-times-container">
          <table class="lap-times-table" id="lapTimesTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Time</th>
                <th>Delta</th>
              </tr>
            </thead>
            <tbody id="lapTimesBody">
              <tr class="empty-state">
                <td colspan="3">No laps recorded yet</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Endurance grid section -->
      <div class="competitor-section endurance-section">
        <div class="panel-header endurance-header">
          <h3>Race Results</h3>
          <div class="endurance-controls">
            <span id="enduranceStatusText" class="status-chip">Endurance stopped</span>
            <span id="leaderboardStatusText" class="status-chip">Leaderboard stopped</span>
            <span id="enduranceAsOf" class="timestamp-chip">--</span>
            <span id="leaderboardAsOf" class="timestamp-chip">--</span>
            <div class="race-clock-controls">
              <div class="race-clock-display">
                <div class="race-clock-label">Race Clock</div>
                <div class="race-clock-time" id="raceCountdownValue">04:00:00</div>
                <div class="race-clock-status" id="raceTimerStatusText">Waiting to start</div>
              </div>
              <button id="startRaceTimerBtn" class="btn btn-primary btn-compact race-clock-start-btn">Start 4h Race</button>
            </div>
            <select id="trackedCarSelect" class="tracked-car-select">
              <option value="">Track car...</option>
            </select>
            <button id="toggleRaceTrackingBtn" class="btn btn-secondary btn-compact" title="Start endurance and leaderboard polling">Start Tracking</button>
          </div>
        </div>
        <div class="tracked-car-card" id="trackedCarSummary">
          <div class="empty-state">Select a car to track</div>
        </div>
        <div class="race-results-container">
          <!-- Endurance Grid Section -->
          <div class="race-results-panel endurance-panel-container">
            <div class="race-results-header">
              <h4>Endurance Grid</h4>
              <button id="refreshEnduranceBtn" class="btn-icon" title="Refresh">ğŸ”„</button>
            </div>
            <div class="competitor-container endurance-table-container">
              <table class="endurance-table" id="enduranceTable">
                <thead>
                  <tr>
                    <th>Pos</th>
                    <th>Car #</th>
                    <th>School</th>
                    <th>Team</th>
                    <th>Comments</th>
                  </tr>
                </thead>
                <tbody id="enduranceTableBody">
                  <tr class="empty-state-row"><td colspan="5">No endurance data yet</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Penalties Section -->
          <div class="race-results-panel penalties-panel-container">
            <div class="penalties-header-section">
              <div class="penalties-title-row">
                <h4>Penalties</h4>
                <div class="penalties-status-group">
                  <span id="penaltiesStatusText" class="status-chip">Penalties stopped</span>
                  <span id="penaltiesAsOf" class="timestamp-chip">Black Flags â€¢ --</span>
                  <button id="refreshPenaltiesBtn" class="btn-icon" title="Refresh penalties">ğŸ”„</button>
                </div>
              </div>
              <div class="penalties-header-controls">
                <div class="penalties-car-selector">
                  <label for="penaltiesCar">Car:</label>
                  <select id="penaltiesCar" class="penalties-car-select">
                    <option value="">All cars</option>
                  </select>
                </div>
                <div class="penalties-actions">
                  <button id="addPenaltyBtn" class="btn btn-primary btn-compact" title="Add penalty to selected car">+ Add</button>
                  <button id="exportPenaltiesBtn" class="btn btn-secondary btn-compact" title="Export penalties">Export</button>
                </div>
              </div>
            </div>
            <div id="penaltiesContent" class="penalties-content">
              <div class="empty-state">Select a car to view or add penalties</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Load external libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Leaflet.draw -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <!-- togeojson for GPX -> GeoJSON conversion -->
  <script src="https://unpkg.com/togeojson@0.16.0/dist/togeojson.min.js"></script>
  
  <!-- Load application scripts -->
  <script src="lap_manager.js"></script>
  <script src="track_map.js"></script>
  <script src="penalties.js"></script>
  <script src="resize_handler.js"></script>
  <script src="renderer.js"></script>

  <!-- Hidden file input for track import -->
  <input type="file" id="trackFileInput" accept=".geojson,application/geo+json,.json,.gpx" style="display:none" />
</body>
</html>
