//I pledge my honor that I have abided by the stevens honor system -Gabe Ayan 
#include <SPI.h>
#include <RadioLib.h>
#include <TinyGPSPlus.h>

//Lora pins
#define LORA_NSS      41
#define LORA_SCK       7
#define LORA_MOSI      9
#define LORA_MISO      8
#define LORA_RST      42
#define LORA_BUSY     40
#define LORA_DIO1     39
#define LORA_ANT_SW   38

//Gps pins
#define GPS_RX 7   // ESP32 receives on pin 7
#define GPS_TX 6   // ESP32 transmits on pin 6

HardwareSerial GPSSerial(1);
TinyGPSPlus gps;

Module mod(LORA_NSS, LORA_DIO1, LORA_RST, LORA_BUSY);
SX1262 radio(&mod);

bool gpsTestRunning = false;
int gpsTestIndex = 0;

struct TestPoint {
  double lat;
  double lon;
  double alt;
};

TestPoint testPoints[] = {
{40.74613626997289, -74.02465124611068, 0},
{40.74611308900228, -74.02463848438045, 0},
{40.74608635421261, -74.02463259797845, 0},
{40.74605849875994, -74.02463055820921, 0},
{40.7460199030493, -74.02462070231063, 0},
{40.74599023666556, -74.02461233489551, 0},
{40.74596806036325, -74.02460069854858, 0},
{40.74594335655387, -74.02458763183432, 0},
{40.74591011758311, -74.02457136776478, 0},
{40.74587288043413, -74.02455743599367, 0},
{40.74585195676079, -74.02453904245166, 0},
{40.74582252011255, -74.02451931541758, 0},
{40.74579146022121, -74.02452055217822, 0},
{40.74576014104426, -74.02453337565777, 0},
{40.74572644038896, -74.02456151104155, 0},
{40.74569644151476, -74.0245851157122, 0},
{40.74567090107819, -74.02461361757521, 0},
{40.74565104838867, -74.02464000202633, 0},
{40.74562151021271, -74.02467488356891, 0},
{40.74559453495364, -74.02469966166724, 0},
{40.74557132136507, -74.02473880100241, 0},
{40.74555247986043, -74.02478270422759, 0},
{40.74555584934013, -74.02483196548766, 0},
{40.74556246421591, -74.02489053797238, 0},
{40.74556913543182, -74.02493990321015, 0},
{40.74556924471435, -74.02498741798868, 0},
{40.74556787705887, -74.02502316612143, 0},
{40.74555516963835, -74.02505409941719, 0},
{40.74553568652681, -74.02507421425233, 0},
{40.74550878563384, -74.02508869522852, 0},
{40.74547470660662, -74.02510310632574, 0},
{40.74543935093229, -74.02512355203386, 0},
{40.74541290843185, -74.0251410156268, 0},
{40.7453864534128, -74.02516770753626, 0},
{40.74535260881552, -74.02520043759266, 0},
{40.74532593703164, -74.02523681259332, 0},
{40.74531033035623, -74.02526797447001, 0},
{40.74529200073041, -74.02531229568105, 0},
{40.74527395362138, -74.02536186323921, 0},
{40.74526495868814, -74.02542829519555, 0},
{40.745253625818, -74.02546898741568, 0},
{40.74523779000359, -74.02553433112465, 0},
{40.74521935230805, -74.02557716802666, 0},
{40.74519785431238, -74.02561004587167, 0},
{40.74516399211157, -74.02562618722239, 0},
{40.74513730264655, -74.02566157028505, 0},
{40.74511739988531, -74.02569078407186, 0},
{40.74508945420586, -74.02571962787378, 0},
{40.745064731028, -74.02573913922767, 0},
{40.74503107361378, -74.02576932418992, 0},
{40.74500386558044, -74.02578882431274, 0},
{40.74496860309593, -74.02581006236015, 0},
{40.74492388119231, -74.02582947778473, 0},
{40.74487733795436, -74.02584582319646, 0},
{40.74482566565216, -74.0258643505372, 0},
{40.7447801398519, -74.02588066808744, 0},
{40.74473253883168, -74.02589744680878, 0},
{40.74467916119099, -74.02590836735959, 0},
{40.74463658510639, -74.02592702751352, 0},
{40.74458181789362, -74.0259380025888, 0},
{40.74454539889007, -74.0259487225091, 0},
{40.74450047513454, -74.02595810515439, 0},
{40.7444692685709, -74.02596829518474, 0},
{40.74442888299766, -74.02598216945799, 0},
{40.74439143853358, -74.02599139517565, 0},
{40.74434967958953, -74.02600383556459, 0},
{40.74430120295638, -74.02601536945214, 0},
{40.74426921602545, -74.02602543145223, 0},
{40.74422070352047, -74.02604205909572, 0},
{40.74418236096681, -74.02605482035929, 0},
{40.74413886836394, -74.02607592256078, 0},
{40.74408497659485, -74.02609137727845, 0},
{40.74403898776362, -74.02610415773184, 0},
{40.74399134597444, -74.0261133819389, 0},
{40.74395205346156, -74.02612553122589, 0},
{40.74390790752153, -74.02614140866402, 0},
{40.74383684109114, -74.02615438518723, 0},
{40.74378220595253, -74.02615164304945, 0},
{40.7437409489533, -74.02614646293895, 0},
{40.7436915402232, -74.02613518313407, 0},
{40.74363168478263, -74.02612065477595, 0},
{40.74357953973251, -74.02608275604832, 0},
{40.74355902497937, -74.02602525043551, 0},
{40.74354058206231, -74.02596446389657, 0},
{40.74351457007296, -74.02589960919624, 0},
{40.74350044158349, -74.02584250955626, 0},
{40.74349405673141, -74.02579229962566, 0},
{40.74352002122934, -74.02573625983368, 0},
{40.74356686831457, -74.02568522754108, 0},
{40.7436298152209, -74.02562698775996, 0},
{40.74367720353222, -74.02557851476718, 0},
{40.74372011113433, -74.02553024429479, 0},
{40.74375316678906, -74.025492292613, 0},
{40.74378124178803, -74.02545739180216, 0},
{40.74381528617503, -74.02542722234146, 0},
{40.7438513391898, -74.02538599861391, 0},
{40.74389042029554, -74.02533864332075, 0},
{40.74393506630322, -74.02529572989936, 0},
{40.74398068121046, -74.02525030438076, 0},
{40.74400851844503, -74.02521237312271, 0},
{40.74405406286319, -74.02515955542958, 0},
{40.74410247104712, -74.02509976342253, 0},
{40.74414285778565, -74.0250545913364, 0},
{40.74418719880433, -74.02500992172314, 0},
{40.74423921204291, -74.0249483135424, 0},
{40.74429920869866, -74.02489496797781, 0},
{40.74433099606225, -74.02486186953291, 0},
{40.74439182515827, -74.0247854152657, 0},
{40.74444470338346, -74.02473511756571, 0},
{40.74449433746842, -74.02468312920817, 0},
{40.74454223345493, -74.02462754002752, 0},
{40.74459646367191, -74.02457711325467, 0},
{40.74464296640197, -74.0245254026718, 0},
{40.74469630327496, -74.02448501624372, 0},
{40.74475691275381, -74.02442521154265, 0},
{40.74480496296511, -74.02438740367744, 0},
{40.74485225332358, -74.02435772192889, 0},
{40.74488658636923, -74.02434866962645, 0},
{40.74491406239061, -74.02433640037559, 0},
{40.74494791186465, -74.02430891285064, 0},
{40.74496370855702, -74.02428514105929, 0},
{40.74497671293156, -74.02426121167898, 0},
{40.74500351332433, -74.02423937432027, 0},
{40.74503381381678, -74.02422256695631, 0},
{40.74507124748968, -74.02421552023637, 0},
{40.7450974743952, -74.02421903865613, 0},
{40.74514877645949, -74.02422114731375, 0},
{40.74519386759991, -74.02421906931315, 0},
{40.74523141384985, -74.02420138446033, 0},
{40.74527296751011, -74.0241770502472, 0},
{40.74532256769514, -74.02413959221181, 0},
{40.74536828919619, -74.02410711079047, 0},
{40.74540592537229, -74.02408227615638, 0},
{40.74559162482046, -74.02402033935465, 0},
{40.74572139523733, -74.02398910805039, 0},
{40.74580716864288, -74.02396012918197, 0},
{40.74586523790669, -74.02394444189616, 0},
{40.74591695001041, -74.02394822276779, 0},
{40.74598506558596, -74.02396314616558, 0},
{40.74610081845135, -74.02402288758664, 0},
{40.74619614038934, -74.02406385566542, 0},
{40.74629717136106, -74.02410767130286, 0},
{40.74637416474435, -74.02416182108627, 0},
{40.74645654690701, -74.02423433217552, 0},
{40.74651549339766, -74.02431347257017, 0},
{40.74657150410481, -74.0243998899909, 0},
{40.74662388359765, -74.02446162531956, 0},
{40.7466758388736, -74.02455077420922, 0},
{40.74672337222921, -74.02463393900652, 0},
{40.7467197398204, -74.02467078175398, 0},
{40.74670616464923, -74.02470807920099, 0},
{40.74668109747579, -74.02473795517902, 0},
{40.7466387509187, -74.02475618427424, 0},
{40.74655440980812, -74.02479576907515, 0},
{40.74647776937282, -74.0248087368352, 0},
{40.74643119917354, -74.02481617539934, 0},
{40.74640791407391, -74.02481989468143, 0},
{40.74638462897428, -74.02482361396349, 0},
{40.7463013266955, -74.02481666889364, 0},
{40.74622983861763, -74.02480976581766, 0},
{40.74619005236291, -74.0247458847067, 0},
{40.74615863939123, -74.02466906014095, 0},
{40.74613626997289, -74.02465124611068, 0}
};
int numTestPoints = sizeof(testPoints) / sizeof(testPoints[0]);

void setup() {
  Serial.begin(115200);
  delay(1000);

  pinMode(LED_BUILTIN, OUTPUT);

  //starts gps over uart
  GPSSerial.begin(9600, SERIAL_8N1, GPS_RX, GPS_TX);
  Serial.println("GPS initialized on pins 6/7");

  //starts lora over spi
  SPI.begin(LORA_SCK, LORA_MISO, LORA_MOSI, LORA_NSS);
  int state = radio.begin();

  if (state != RADIOLIB_ERR_NONE) {
    Serial.printf("LoRa init failed (code %d)\n", state);
    while (true);
  }

  Serial.println("LoRa SX1262 Initialized.");
}

//commands from dashboard 
void runCommand(String cmd) {
  cmd.trim();
  cmd.toUpperCase();

  Serial.print("Received command: ");
  Serial.println(cmd);

  if (cmd == "LED_ON") {
    digitalWrite(LED_BUILTIN, HIGH);
    Serial.println("LED turned ON");
  }

  else if (cmd == "LED_OFF") {
    digitalWrite(LED_BUILTIN, LOW);
    Serial.println("LED turned OFF");
  }

  else if (cmd == "REBOOT") {
    Serial.println("Rebooting...");
    delay(300);
    ESP.restart();
  }

  else if (cmd == "PING") {
    Serial.println("Replying: :)");
    radio.transmit(":)");
  }

  else if (cmd == "GPS_TEST") {
    Serial.println("Starting GPS Test Data");
    gpsTestRunning = true;
    gpsTestIndex = 0;

    // will send test data in loop() when gpsTestRunning is true
  }

  else if (cmd == "GPS_STOP") {
    Serial.println("Stopping GPS Test Data");
    gpsTestRunning = false;
  }

  else {
    Serial.println("Unknown command");
  }
}

void checkForCommands() {
  String incoming = "";
  int state = radio.receive(incoming);

  if (state == RADIOLIB_ERR_NONE) {
    Serial.print("[LoRa RX] ");
    Serial.println(incoming);
    runCommand(incoming);
  }
}

//sets up json file for dashboard in correct format
String buildTelemetryJSON(double lat, double lon, double alt, int sats = 0, double hdop = 0) {
  String json = "{";
  json += "\"ts\":" + String(millis()) + ",";
  json += "\"lat\":" + String(lat, 8) + ",";
  json += "\"lon\":" + String(lon, 8) + ",";
  json += "\"alt\":" + String(alt, 1) + ",";
  json += "\"sats\":" + String(sats) + ",";
  json += "\"hdop\":" + String(hdop, 2);
  json += "}";

  return json;
}

void loop() {

  // Continuously feed GPS parser
  while (GPSSerial.available()) {
    gps.encode(GPSSerial.read());
  }

  // Listen for incoming commands
  checkForCommands();

  if (gpsTestRunning) {
    //send next test GPS point
    TestPoint tp = testPoints[gpsTestIndex];
    String json = buildTelemetryJSON(tp.lat, tp.lon, tp.alt);
    Serial.print("[TX GPS TEST] ");
    Serial.println(json);

    int state = radio.transmit(json);
    if (state != RADIOLIB_ERR_NONE) {
      Serial.printf("TX failed (%d)\n", state);
    }

    gpsTestIndex++;
    if (gpsTestIndex >= numTestPoints) gpsTestIndex = 0;

    delay(1000);
    return; // skip real GPS sending while test is running
  }

  // If GPS has good data, send telemetry
  if (gps.location.isValid() && gps.location.age() < 2000) {

    String json = buildTelemetryJSON(
      gps.location.lat(),
      gps.location.lng(),
      gps.altitude.meters(),
      gps.satellites.value(),
      gps.hdop.hdop()
    );
    Serial.print("[TX] ");
    Serial.println(json);

    int state = radio.transmit(json);

    if (state != RADIOLIB_ERR_NONE) {
      Serial.printf("TX failed (%d)\n", state);
    }
  }
  else {
    Serial.println("Waiting for GPS fix...");
  }

  delay(1000);
}
